# æ•°æ®é›†ä¼˜åŒ–è¯´æ˜

## âœ… å®Œæˆçš„ä¼˜åŒ–

### 1. åˆå¹¶æ•°æ®é›†æ¨¡å—
- **ä¹‹å‰**: `dataset.py` (224Ã—224) å’Œ `dataset_256.py` (256Ã—256) ä¸¤ä¸ªç‹¬ç«‹æ–‡ä»¶
- **ç°åœ¨**: ç»Ÿä¸€çš„ `dataset.py`ï¼Œé€šè¿‡å‚æ•°æ§åˆ¶å›¾åƒå°ºå¯¸
- **ä¼˜åŠ¿**: ä»£ç å¤ç”¨ï¼Œæ˜“äºç»´æŠ¤

### 2. æ–°å¢å¹´é¾„åˆ†å±‚æŠ½æ ·åŠŸèƒ½

#### ä¼ ç»Ÿåˆ’åˆ†æ–¹å¼çš„é—®é¢˜
```
æŒ‰å—è¯•è€…IDéšæœºåˆ’åˆ†ï¼š
è®­ç»ƒé›†: 46.7Â±21.8å²
éªŒè¯é›†: 51.2Â±21.4å²  â† å¹´é¾„åˆ†å¸ƒå¯èƒ½ä¸å‡è¡¡
æµ‹è¯•é›†: 47.0Â±22.1å²
```

#### å¹´é¾„åˆ†å±‚æŠ½æ ·çš„ä¼˜åŠ¿
```
æŒ‰å¹´é¾„åˆ†å±‚æŠ½æ ·ï¼ˆæ¯10å²ä¸€ç»„ï¼‰ï¼š
ğŸ“Š å¹´é¾„åˆ†å±‚ç»Ÿè®¡:
  0-10å²: 93äºº â†’ è®­ç»ƒ74äºº, éªŒè¯8äºº, æµ‹è¯•11äºº
  10-20å²: 68äºº â†’ è®­ç»ƒ54äºº, éªŒè¯7äºº, æµ‹è¯•7äºº
  ...ï¼ˆæ¯ä¸ªå¹´é¾„æ®µæŒ‰ç›¸åŒæ¯”ä¾‹åˆ’åˆ†ï¼‰
  80-90å²: 24äºº â†’ è®­ç»ƒ19äºº, éªŒè¯3äºº, æµ‹è¯•2äºº

ç»“æœ:
è®­ç»ƒé›†: 47.1Â±21.7å²
éªŒè¯é›†: 47.9Â±21.2å²  â† å¹´é¾„åˆ†å¸ƒæ›´å‡è¡¡
æµ‹è¯•é›†: 47.1Â±22.4å²
```

**å…³é”®ä¼˜åŠ¿**ï¼š
- âœ… ç¡®ä¿å„å¹´é¾„æ®µåœ¨è®­ç»ƒ/éªŒè¯/æµ‹è¯•é›†ä¸­æ¯”ä¾‹ä¸€è‡´
- âœ… é¿å…æŸä¸ªå¹´é¾„æ®µè¿‡åº¦/æ¬ é‡‡æ ·
- âœ… æé«˜æ¨¡å‹å¯¹å…¨å¹´é¾„æ®µçš„æ³›åŒ–èƒ½åŠ›
- âœ… å‡å°‘å› å¹´é¾„åˆ†å¸ƒå·®å¼‚å¯¼è‡´çš„è¯„ä¼°åå·®

## ä½¿ç”¨æ–¹æ³•

### åŸºç¡€ä½¿ç”¨
```python
from dataset import load_dataset

# æ–¹å¼1: é»˜è®¤æ¨¡å¼ï¼ˆéšæœºåˆ’åˆ†ï¼‰
train, val, test = load_dataset(
    image_dir='/path/to/images',
    excel_path='/path/to/excel',
    image_size=224,
    use_age_stratify=False  # é»˜è®¤
)

# æ–¹å¼2: å¹´é¾„åˆ†å±‚æŠ½æ ·
train, val, test = load_dataset(
    image_dir='/path/to/images',
    excel_path='/path/to/excel',
    image_size=256,
    use_age_stratify=True,
    age_bin_width=10  # æ¯10å²ä¸€ç»„
)
```

### è®­ç»ƒè„šæœ¬ä½¿ç”¨
```bash
# é»˜è®¤æ¨¡å¼
python train_mae.py --batch-size 96

# å¯ç”¨å¹´é¾„åˆ†å±‚æŠ½æ ·
python train_mae.py --use-age-stratify --age-bin-width 10 --batch-size 96

# 256Ã—256 + å¹´é¾„åˆ†å±‚
python train_mae.py --image-size 256 --use-age-stratify --batch-size 64
```

## å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `image_size` | int | 224 | å›¾åƒresizeå°ºå¯¸ |
| `use_age_stratify` | bool | False | æ˜¯å¦ä½¿ç”¨å¹´é¾„åˆ†å±‚æŠ½æ · |
| `age_bin_width` | int | 10 | å¹´é¾„åˆ†ç»„å®½åº¦ï¼ˆå²ï¼‰ |
| `test_size` | float | 0.2 | æµ‹è¯•é›†æ¯”ä¾‹ |
| `val_size` | float | 0.1 | éªŒè¯é›†æ¯”ä¾‹ |
| `random_state` | int | 42 | éšæœºç§å­ |

## é€‚ç”¨åœºæ™¯

### æ¨èä½¿ç”¨å¹´é¾„åˆ†å±‚æŠ½æ ·çš„æƒ…å†µ
- âœ… æ•°æ®é›†è·¨è¶Šè¾ƒå¤§å¹´é¾„èŒƒå›´ï¼ˆå¦‚0-88å²ï¼‰
- âœ… å¸Œæœ›æ¨¡å‹å¯¹æ‰€æœ‰å¹´é¾„æ®µéƒ½æœ‰è‰¯å¥½æ³›åŒ–èƒ½åŠ›
- âœ… éœ€è¦å…¬å¹³è¯„ä¼°æ¨¡å‹åœ¨ä¸åŒå¹´é¾„æ®µçš„æ€§èƒ½
- âœ… é¿å…å› å¹´é¾„åˆ†å¸ƒåå·®å¯¼è‡´çš„è¿‡æ‹Ÿåˆ

### å¯ä»¥ä½¿ç”¨éšæœºåˆ’åˆ†çš„æƒ…å†µ
- å¹´é¾„åˆ†å¸ƒè¾ƒé›†ä¸­
- æ•°æ®é‡è¶³å¤Ÿå¤§ï¼ˆæ¯ä¸ªå¹´é¾„æ®µæ ·æœ¬éƒ½å¾ˆå¤šï¼‰
- å¿«é€Ÿå®éªŒ/è°ƒè¯•

## æŠ€æœ¯ç»†èŠ‚

### é˜²æ­¢æ•°æ®æ³„éœ²
æ— è®ºä½¿ç”¨å“ªç§åˆ’åˆ†æ–¹å¼ï¼Œéƒ½ä¸¥æ ¼æŒ‰å—è¯•è€…IDåˆ’åˆ†ï¼š
- åŒä¸€å—è¯•è€…çš„æ‰€æœ‰å›¾åƒåªä¼šå‡ºç°åœ¨ä¸€ä¸ªé›†åˆï¼ˆè®­ç»ƒ/éªŒè¯/æµ‹è¯•ï¼‰
- é¿å…åŒä¸€å—è¯•è€…çš„ä¸åŒå›¾åƒåˆ†æ•£åˆ°ä¸åŒé›†åˆå¯¼è‡´çš„æ•°æ®æ³„éœ²

### åˆ†å±‚æŠ½æ ·å®ç°
```python
# sklearnçš„train_test_splitæ”¯æŒåˆ†å±‚æŠ½æ ·
train_test_split(
    subjects,
    stratify=age_groups,  # æŒ‰å¹´é¾„ç»„åˆ†å±‚
    test_size=0.2,
    random_state=42
)
```

### å¹´é¾„åˆ†ç»„é€»è¾‘
```python
def get_age_group(age, bin_width=10):
    """0-10å² â†’ "0-10", 35å² â†’ "30-40", 88å² â†’ "80-90" """
    lower = int(age // bin_width) * bin_width
    upper = lower + bin_width
    return f"{lower}-{upper}"
```

## å®éªŒå»ºè®®

### å¯¹æ¯”å®éªŒ
å»ºè®®åŒæ—¶è®­ç»ƒä¸¤ä¸ªæ¨¡å‹è¿›è¡Œå¯¹æ¯”ï¼š

```bash
# æ¨¡å‹A: éšæœºåˆ’åˆ†
python train_mae.py --seed 42 --output-dir outputs/random_split

# æ¨¡å‹B: å¹´é¾„åˆ†å±‚æŠ½æ ·
python train_mae.py --use-age-stratify --seed 42 --output-dir outputs/age_stratify
```

ç„¶åå¯¹æ¯”ï¼š
- æ€»ä½“MAE/RMSE
- å„å¹´é¾„æ®µçš„è¯¯å·®åˆ†å¸ƒ
- éªŒè¯é›†å’Œæµ‹è¯•é›†çš„æ€§èƒ½ä¸€è‡´æ€§

### é¢„æœŸæ•ˆæœ
å¹´é¾„åˆ†å±‚æŠ½æ ·é€šå¸¸èƒ½å¸¦æ¥ï¼š
- æ›´ç¨³å®šçš„éªŒè¯é›†è¡¨ç°
- æµ‹è¯•é›†æ€§èƒ½æ›´æ¥è¿‘éªŒè¯é›†æ€§èƒ½
- å„å¹´é¾„æ®µè¯¯å·®åˆ†å¸ƒæ›´å‡åŒ€
- ç•¥å¾®æå‡æ€»ä½“æ€§èƒ½ï¼ˆ0.1-0.3å²MAEï¼‰

## ä»£ç ç¤ºä¾‹

### æŸ¥çœ‹å¹´é¾„åˆ†å¸ƒç»Ÿè®¡
```python
from dataset import load_dataset

train, val, test = load_dataset(
    image_dir='/home/szdx/LNX/data/TA/Healthy/Images',
    excel_path='/home/szdx/LNX/data/TA/characteristics.xlsx',
    use_age_stratify=True,
    age_bin_width=10
)

# è¾“å‡ºå°†æ˜¾ç¤ºï¼š
# ğŸ“Š å¹´é¾„åˆ†å±‚ç»Ÿè®¡ï¼ˆæ¯10å²ä¸€ç»„ï¼‰:
#   0-10å²: 93 ä¸ªå—è¯•è€…
#   10-20å²: 68 ä¸ªå—è¯•è€…
#   ...
```

### è‡ªå®šä¹‰å¹´é¾„åˆ†ç»„
```python
# æ›´ç»†ç²’åº¦ï¼šæ¯5å²ä¸€ç»„
train, val, test = load_dataset(..., age_bin_width=5)
# 0-5å², 5-10å², 10-15å², ...

# æ›´ç²—ç²’åº¦ï¼šæ¯20å²ä¸€ç»„  
train, val, test = load_dataset(..., age_bin_width=20)
# 0-20å², 20-40å², 40-60å², ...
```

## å‘åå…¼å®¹æ€§

æ—§ä»£ç æ— éœ€ä¿®æ”¹ï¼š
```python
# æ—§ä»£ç ä»ç„¶å¯ä»¥æ­£å¸¸å·¥ä½œ
from dataset import load_dataset
train, val, test = load_dataset(image_dir, excel_path)
# è‡ªåŠ¨ä½¿ç”¨224Ã—224, ä¸å¯ç”¨å¹´é¾„åˆ†å±‚
```

## æ€»ç»“

| ç‰¹æ€§ | ä¹‹å‰ | ç°åœ¨ |
|------|------|------|
| **æ•°æ®é›†æ¨¡å—** | 2ä¸ªæ–‡ä»¶ | 1ä¸ªç»Ÿä¸€æ–‡ä»¶ |
| **å›¾åƒå°ºå¯¸** | å›ºå®š | å‚æ•°åŒ– |
| **åˆ’åˆ†ç­–ç•¥** | ä»…éšæœº | éšæœº + å¹´é¾„åˆ†å±‚ |
| **å¹´é¾„åˆ†ç»„** | ä¸æ”¯æŒ | å¯é…ç½®ï¼ˆ5/10/20å²ç­‰ï¼‰ |
| **ä»£ç ç»´æŠ¤** | åˆ†æ•£ | é›†ä¸­ç»Ÿä¸€ |

**æ¨èé…ç½®**ï¼š
```bash
python train_mae.py \
    --image-size 256 \
    --use-age-stratify \
    --age-bin-width 10 \
    --loss mae \
    --batch-size 64
```
